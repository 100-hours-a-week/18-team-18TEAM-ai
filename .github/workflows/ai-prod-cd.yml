name: CD - PROD (AI)

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ai-prod-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 25

    env:
      APP_NAME: "bizkit-AI"
      APP_STAGE: prod
      PYTHON_VERSION: "3.12"
      HEALTH_URL: http://127.0.0.1:8000/health

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies (for checks + semantic-release)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-semantic-release

      - name: Build (compileall)
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall app

      - name: Semantic Release (prod)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "action@github.com"
          semantic-release -c releaserc.toml version

      - name: Read version from VERSION
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(tr -d ' \n\r\t' < VERSION)"
          [[ -n "$VERSION" ]] || (echo "VERSION file is empty" >&2; exit 1)
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build AI Deploy Artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}

          OUT_ARCHIVE="bizkit-ai-${VERSION}.tar.gz"

          tar \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='.venv' \
            --exclude='venv' \
            --exclude='.pytest_cache' \
            -czf "$OUT_ARCHIVE" \
            app \
            requirements.txt \
            VERSION \
            README.md || {
              echo "Failed to create archive" >&2
              exit 1
            }

          echo "OUT_ARCHIVE=$OUT_ARCHIVE" >> "$GITHUB_ENV"
          ls -al "$OUT_ARCHIVE"

      - name: Upload Build Artifact to S3
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUCKET="${{ secrets.S3_BUCKET }}"

          RELEASE_KEY="${{ secrets.S3_PREFIX }}/${APP_STAGE}/releases/ai/${VERSION}/bizkit-ai-${VERSION}.tar.gz"

          aws s3 cp "$OUT_ARCHIVE" "s3://$BUCKET/${RELEASE_KEY}" --cache-control no-cache

          echo "BUCKET=$BUCKET" >> "$GITHUB_ENV"
          echo "RELEASE_KEY=$RELEASE_KEY" >> "$GITHUB_ENV"

      - name: Build CodeDeploy bundle (AI)
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUCKET="$BUCKET"
          RELEASE_KEY="$RELEASE_KEY"

          rm -rf bundle && mkdir -p bundle/codedeploy/ai/hooks

          cp codedeploy/ai/appspec.yml bundle/appspec.yml
          cp deploy-ai.sh bundle/deploy-ai.sh
          cp -r codedeploy/ai/hooks/* bundle/codedeploy/ai/hooks/

          chmod +x bundle/deploy-ai.sh || true
          chmod +x bundle/codedeploy/ai/hooks/* || true

          ARCHIVE_URL="$(aws s3 presign "s3://$BUCKET/$RELEASE_KEY" --expires-in 3600)"
          ESCAPED_URL=$(printf "%s" "$ARCHIVE_URL" | sed "s/'/'\\\\''/g")

          cat > bundle/codedeploy/ai/env.sh <<EOF
          RELEASE_ID='${VERSION}'
          ARCHIVE_URL='${ESCAPED_URL}'
          HEALTH_URL='${HEALTH_URL}'
          EOF

          (cd bundle && zip -r ../bundle.zip .)
          unzip -l bundle.zip

      - name: Upload bundle.zip to S3
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUNDLE_KEY="${{ secrets.S3_PREFIX }}/${APP_STAGE}/codedeploy/ai/${VERSION}/bundle-${{ github.run_id }}.zip"

          aws s3 cp bundle.zip "s3://$BUCKET/$BUNDLE_KEY"
          echo "BUNDLE_KEY=$BUNDLE_KEY" >> "$GITHUB_ENV"

      - name: Create CodeDeploy deployment & wait
        shell: bash
        run: |
          set -euo pipefail

          APP="${{ secrets.CODEDEPLOY_APP_AI_PROD }}"
          DG="${{ secrets.CODEDEPLOY_DG_AI_PROD }}"

          echo "BUCKET=$BUCKET"
          echo "BUNDLE_KEY=$BUNDLE_KEY"

          DEPLOY_ID="$(aws deploy create-deployment \
            --application-name "$APP" \
            --deployment-group-name "$DG" \
            --s3-location bucket="$BUCKET",key="$BUNDLE_KEY",bundleType=zip \
            --file-exists-behavior OVERWRITE \
            --query "deploymentId" --output text)"

          echo "deploymentId=$DEPLOY_ID"
          aws deploy wait deployment-successful --deployment-id "$DEPLOY_ID"
          echo "CodeDeploy SUCCESS"

      - name: Notify Discord on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          MESSAGE="AI PROD CD 실패
          Repo: \`${{ github.repository }}\`
          Branch: \`${{ github.ref_name }}\`
          Workflow: \`${{ github.workflow }}\`
          Job: \`${{ github.job }}\`
          Actor: \`${{ github.actor }}\`
          Stage: \`${APP_STAGE}\`
          링크: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          JSON_MESSAGE=$(printf '%s\n' "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps({"content": sys.stdin.read()}))')
          curl -X POST -H "Content-Type: application/json" -d "$JSON_MESSAGE" "$DISCORD_WEBHOOK_URL"
