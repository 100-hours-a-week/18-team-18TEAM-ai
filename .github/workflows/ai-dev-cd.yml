name: CD - Dev(AI)

on:
  pull_request:
    branches: [ "develop" ]
    types: [ closed ]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ai-dev-cd-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-24.04
    timeout-minutes: 20

    env:
      APP_NAME: "BizKit-AI"
      APP_STAGE: dev
      HEALTH_URL: http://127.0.0.1:8000/ai/health

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install python-semantic-release

      - name: Compile Check
        run: python -m compileall app

      - name: Semantic Release (dev)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          semantic-release -c releaserc.toml version

      - name: Read version from VERSION file
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(tr -d ' \n\r\t' < VERSION)"
          [[ -n "$VERSION" ]] || (echo "VERSION file is empty" >&2; exit 1)
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build AI Deploy Artifact
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}

          OUT_ARCHIVE="bizkit-ai-${VERSION}.tar.gz"

          tar \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.github' \
            -czf "$OUT_ARCHIVE" \
            app \
            run_worker.py \
            requirements.txt \
            VERSION \
            README.md || {
              echo "Failed to create archive" >&2
              exit 1
            }

          echo "OUT_ARCHIVE=$OUT_ARCHIVE" >> "$GITHUB_ENV"
          ls -al "$OUT_ARCHIVE"

      - name: Upload Build Artifact to S3
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          BUCKET="${{ secrets.S3_BUCKET }}"
          S3_PREFIX="${{ secrets.S3_PREFIX }}"

          RELEASE_KEY="${S3_PREFIX}/${APP_STAGE}/releases/ai/${VERSION}/bizkit-ai-${VERSION}.tar.gz"

          aws s3 cp "$OUT_ARCHIVE" "s3://$BUCKET/${RELEASE_KEY}" --cache-control no-cache

          echo "BUCKET=$BUCKET" >> "$GITHUB_ENV"
          echo "RELEASE_KEY=$RELEASE_KEY" >> "$GITHUB_ENV"

      - name: Build CodeDeploy bundle (AI)
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}

          rm -rf bundle && mkdir -p bundle/codedeploy/ai/hooks

          cp codedeploy/ai/appspec.yml bundle/appspec.yml
          cp deploy-ai.sh bundle/deploy-ai.sh
          cp -r codedeploy/ai/hooks/* bundle/codedeploy/ai/hooks/

          ARCHIVE_URL="$(aws s3 presign "s3://$BUCKET/$RELEASE_KEY" --expires-in 3600)"
          ESCAPED_URL=$(printf "%s" "$ARCHIVE_URL" | sed "s/'/'\\\\''/g")

          cat > bundle/codedeploy/ai/env.sh <<EOF
          RELEASE_ID='${VERSION}'
          ARCHIVE_URL='${ESCAPED_URL}'
          HEALTH_URL='${HEALTH_URL}'
          EOF

          (cd bundle && zip -r ../bundle.zip .)
          unzip -l bundle.zip

      - name: Upload bundle.zip to S3
        shell: bash
        run: |
          set -euo pipefail
          VERSION=${{ steps.ver.outputs.value }}
          S3_PREFIX="${{ secrets.S3_PREFIX }}"
          BUNDLE_KEY="${S3_PREFIX}/${APP_STAGE}/codedeploy/ai/${VERSION}/bundle-${{ github.run_id }}.zip"

          aws s3 cp bundle.zip "s3://$BUCKET/$BUNDLE_KEY"
          echo "BUNDLE_KEY=$BUNDLE_KEY" >> "$GITHUB_ENV"

      - name: Create CodeDeploy deployment & wait
        shell: bash
        run: |
          set -euo pipefail

          APP="${{ secrets.CODEDEPLOY_APP_AI_DEV }}"
          DG="${{ secrets.CODEDEPLOY_DG_AI_DEV }}"

          DEPLOY_ID="$(aws deploy create-deployment \
            --application-name "$APP" \
            --deployment-group-name "$DG" \
            --s3-location bucket="$BUCKET",key="$BUNDLE_KEY",bundleType=zip \
            --file-exists-behavior OVERWRITE \
            --query "deploymentId" --output text)"

          echo "deploymentId=$DEPLOY_ID"
          aws deploy wait deployment-successful --deployment-id "$DEPLOY_ID"
          echo "CodeDeploy SUCCESS"

      - name: Notify Discord on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          MESSAGE="AI Dev CD 실패
          Repo: \`${{ github.repository }}\`
          Branch: \`${{ github.ref_name }}\`
          Workflow: \`${{ github.workflow }}\`
          Job: \`${{ github.job }}\`
          Author: \`${{ github.actor }}\`
          Stage: \`${APP_STAGE}\`
          링크: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          JSON_MESSAGE=$(printf '%s\n' "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps({"content": sys.stdin.read()}))')
          curl -X POST -H "Content-Type: application/json" -d "$JSON_MESSAGE" "$DISCORD_WEBHOOK_URL"
